services:
  db:
    image: mysql:8.0.36
    container_name: whennawa-db
    restart: unless-stopped
    env_file:
      - /home/ubuntu/whennawa-env/backend.env
    environment:
      TZ: Asia/Seoul
    command:
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_unicode_ci
    ports:
      - "3306:3306"
    volumes:
      - mysql-data:/var/lib/mysql
    healthcheck:
      test: ["CMD-SHELL", "mysqladmin ping -h 127.0.0.1 -u root -p$$MYSQL_ROOT_PASSWORD --silent"]
      interval: 10s
      timeout: 5s
      retries: 12

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: whennawa-backend
    restart: unless-stopped
    depends_on:
      db:
        condition: service_healthy
    env_file:
      - /home/ubuntu/whennawa-env/backend.env
    environment:
      SERVER_PORT: 8080
      DB_URL: jdbc:mysql://db:3306/whennawa?useSSL=false&allowPublicKeyRetrieval=true&serverTimezone=Asia/Seoul&characterEncoding=UTF-8
      DB_DRIVER: com.mysql.cj.jdbc.Driver
      JPA_DDL_AUTO: validate
      APP_CORS_ALLOWED_ORIGINS: http://whennawa.shop:3000
    ports:
      - "8080:8080"

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        NEXT_PUBLIC_API_BASE_URL: http://whennawa.shop:8080
        NEXT_PUBLIC_USE_MOCK_DATA: "false"
    container_name: whennawa-frontend
    restart: unless-stopped
    depends_on:
      - backend
    env_file:
      - /home/ubuntu/whennawa-env/frontend.env
    environment:
      INTERNAL_API_BASE_URL: http://backend:8080
    ports:
      - "3000:3000"

 dozzle:
   image: amir20/dozzle:latest
   container_name: dozzle
   restart: unless-stopped
   ports:
     - "9999:8080"
   volumes:
     - /var/run/docker.sock:/var/run/docker.sock

volumes:
  mysql-data: